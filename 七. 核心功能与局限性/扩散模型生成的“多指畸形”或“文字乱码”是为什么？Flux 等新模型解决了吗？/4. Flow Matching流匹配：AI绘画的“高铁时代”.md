# Flow Matching 技术详解：从“预测噪声”到“预测速度”

如果说 DiT 改变了模型的“骨架”（架构），那么 **Flow Matching (流匹配)** 则彻底重写了模型的“灵魂”（生成算法）。

它是 **Flux**、**Stable Diffusion 3** 以及 **HunyuanVideo** 背后的数学引擎。本文将深入拆解它到底是如何实现的，以及它为什么能让生成过程从“随机漫步”变成“确定性传输”。

---

## 一、 核心视角的转变：Vector Field (速度场)

要理解 Flow Matching 的实现，我们首先要打破对传统 Diffusion 的固有印象。

- **传统 Diffusion (DDPM/DDIM)**：
  模型学习的是 **$\epsilon$ (噪声)**。

  - 训练目标：给出一张加噪图片，猜出加了什么噪。
  - 生成过程：像剥洋葱一样，一层层把噪声剥掉。
  - 数学本质：模拟**随机微分方程 (SDE)**，是一个去噪过程。

- **Flow Matching**：
  模型学习的是 **$v$ (速度/Velocity)**。
  - **核心概念**：想象所有可能的噪点（分布 $p_0$）和所有可能的真实图片（分布 $p_1$）漂浮在空间中。Flow Matching 试图建立一个**速度场 (Velocity Field)**，这个场告诉空间中每一个点：“嘿，如果你想变成一张真实的图，你应该往哪个方向飞，速度是多少？”
  - 生成过程：像叶子随波逐流一样，沿着速度场的指引漂流。
  - 数学本质：求解**常微分方程 (ODE)**，是一个流体传输过程。

---

## 二、 训练过程：如何教会 AI “走直线”？

Flow Matching 最精妙的地方在于它的训练方法——**Conditional Flow Matching (CFM)**。

在训练时，我们不需要解复杂的微分方程，我们采用一种“作弊”的方式来构建训练目标。

### 1. 构建“真理路径”

假设我们有一张纯噪点图 $x_0$ 和一张对应的真实图片 $x_1$。
在数学上，我们可以强行定义一条连接它们的**直线路径**：
$$ x_t = (1 - t) x_0 + t x_1 $$
其中 $t$ 是时间，从 0 走到 1。

这条路径的**速度**（对时间求导）非常简单，就是：
$$ v_t = \frac{d x_t}{d t} = x_1 - x_0 $$

这意味着：为了从噪点 $x_0$ 走到图片 $x_1$，你只需要保持恒定的速度 $(x_1 - x_0)$ 一直走就行了。

### 2. 模型的任务

我们把 $x_t$（某个时刻的混合图）和 $t$（当前时间）喂给神经网络。
告诉它：“请预测一下，现在的速度 $v$ 应该是多少？”

**Loss Function (损失函数)** 非常直观：
$$ L = || v\_{model}(x_t, t) - (x_1 - x_0) ||^2 $$

**人话翻译**：
我们拿着这一对（噪点，原图）告诉模型：
“看好了，从这个噪点变到这张图，最佳路径就是这条直线。你要记住，当你处于这条线上的任何位置时，你的速度方向必须指向终点！”

通过无数对（噪点，原图）的训练，模型最终学会了一个全局的**速度场**。即使给它一个从未见过的噪点，它也能根据学到的规律，计算出一个通往“某种合理图像”的速度方向。

---

## 三、 推理过程：ODE Solver (数值求解)

训练好模型后，生成图片的过程就变成了求解 ODE 的过程。

这就是为什么 Flux 等模型可以使用 **Euler (欧拉)** 求解器的原因。
生成公式变得极其简单：

$$ x*{t+1} = x_t + v*{model}(x_t) \times \Delta t $$

1.  **初始状态**：随机生成一个高斯噪声 $x_0$。
2.  **第一步**：问模型“我现在在 $x_0$，我要往哪走？” 模型返回速度 $v_0$。
3.  **更新**：沿着 $v_0$ 的方向走一步（步长 $\Delta t$），到达 $x_1$。
4.  **循环**：重复上述过程，直到 $t=1$。

### 为什么它比 DDIM 更直？

虽然 DDIM 也是 ODE，但它的推导基础是去噪，路径往往是弯曲的。
而 Flow Matching 在训练时就强制让模型拟合**直线速度 ($x_1 - x_0$)**。
这意味着在推理时，生成的轨迹非常接近直线。

- **弯路 (传统 Diffusion)**：需要很多小步子才能转弯而不掉出轨道 -> **步数多**。
- **直路 (Flow Matching)**：这甚至可以用一步到位（One-step）来近似 -> **步数极少**。

---

## 四、 进阶：Rectified Flow 与蒸馏

Flux 实际上使用的是 **Rectified Flow (整流)** 的变体。

虽然我们训练目标是直线，但在高维空间中，不同的直线可能会交叉、纠缠，导致学出来的速度场比较乱。
**Rectified Flow** 有一个“Reflow”操作：

1.  先用模型生成一批图（走一遍流程，得到一条轨迹）。
2.  把这条生成的轨迹当成新的“真值”，再训练一次模型。

这就像是先把路走通，然后把弯弯曲曲的脚印“拉直”铺成路，再让模型学。
对于 **Flux Schnell** 这样的蒸馏模型，更是使用了 **LADD (Latent Adversarial Diffusion Distillation)** 等技术，强行让 4 步甚至 1 步的预测结果直接对齐终点。

---

## 五、 总结

Flow Matching 的技术核心不在于“画得更好”（虽然确实好了），而在于**“画得更科学”**。

1.  **数学上**：从 SDE (随机) 变成了 ODE (确定)。
2.  **实现上**：从预测噪声 ($\epsilon$) 变成了预测速度 ($v = x_1 - x_0$)。
3.  **结果上**：生成路径被拉直了，从而实现了**少步数**（快）和**高一致性**（稳）。

这也是为什么 **HunyuanVideo** 选择它的原因：只有确定性的 ODE 路径，才能保证视频帧之间不会因为随机性而乱闪。
