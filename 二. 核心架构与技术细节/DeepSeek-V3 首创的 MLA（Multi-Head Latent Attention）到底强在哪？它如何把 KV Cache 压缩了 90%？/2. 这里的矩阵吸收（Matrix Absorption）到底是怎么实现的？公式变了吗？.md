# 这里的矩阵吸收（Matrix Absorption）到底是怎么实现的？公式变了吗？

在上一篇文章中，我们提到了 MLA 的核心魔法是“低秩压缩”，即把巨大的 KV Cache 压缩成了一个极小的 **Latent Vector（潜在向量）**。

很多技术同学看到这里会立刻产生一个疑问：

> “压缩我懂，但计算注意力（Attention）的时候，不是必须得把 $Q$ 和 $K$ 的维度对齐吗？既然 $K$ 被压缩了，难道不需要先把它解压（Up-Projection）成原来的形状，再和 $Q$ 做点积吗？如果解压了，那显存不就又占回来了吗？”

这是一个非常精准的直觉。而 DeepSeek 解决这个问题的核心技巧，就是 **“矩阵吸收（Matrix Absorption）”**。

简单来说，**他们修改了计算公式，让解压过程“消失”在计算步骤里了。**

---

## 1. 传统计算：解压是“显存杀手”

在标准的低秩分解逻辑中，如果我们把 Key 压缩了，计算流程通常是这样的：

1.  **压缩（Down-Projection）**：$K_{compressed} = K \times W_{down}$ （存入 Cache，这一步省显存）
2.  **解压（Up-Projection）**：$K_{restored} = K_{compressed} \times W_{up}$ （**注意！这一步通常在计算前发生**）
3.  **计算分数**：$Score = Q \times K_{restored}^T$

**问题在哪？**
步骤 2 的解压过程，会生成一个巨大的 $K_{restored}$ 矩阵（维度是 $Batch \times SeqLen \times HeadDim$）。虽然它只是临时的，但在计算的一瞬间，显存占用会瞬间飙升。这就像你为了省硬盘把电影压缩了，但看的时候必须解压成 4K 无损格式放进内存里，内存照样撑不住。

---

## 2. 矩阵吸收：利用数学结合律“偷天换日”

DeepSeek 的工程师利用了线性代数中最基础的 **矩阵乘法结合律**：
$$ (A \times B) \times C = A \times (B \times C) $$

让我们把注意力公式展开看看：

- **原始公式**：
  $$ Score = Q \times (K*{compressed} \times W*{up})^T $$
- **利用转置性质 $(AB)^T = B^T A^T$**：
  $$ Score = Q \times (W*{up}^T \times K*{compressed}^T) $$
- **利用结合律（关键一步！）**：
  $$ Score = (Q \times W*{up}^T) \times K*{compressed}^T $$

**看懂了吗？**
原本 $W_{up}$ 是跟在 $K$ 后面用来“解压”的。
现在，我们把 $W_{up}$ **移动到了 $Q$ 的那边**，让 $Q$ 先和 $W_{up}$ 结合。

这就构成了新的计算流程：

1.  **Absorbed Query（吸收了参数的 Q）**：在计算注意力之前，先让 $Q$ 变形，生成一个新的 $Q_{absorbed} = Q \times W_{up}^T$。
2.  **直接计算**：$Score = Q_{absorbed} \times K_{compressed}^T$

---

## 3. 为什么这样就省显存了？

这个变换带来了两个巨大的好处：

1.  **$K$ 再也不用解压了**：
    在整个计算过程中，KV Cache 始终保持着压缩后的 $K_{compressed}$ 状态（即 Latent Vector）。那个巨大的“解压后矩阵”根本从未在显存中出现过。

2.  **计算量并没有显著增加**：
    虽然 $Q$ 需要多乘一个矩阵，但 $Q$ 通常是当前时刻的一个 Token（或者少量 Token），而 $K$ 是历史上成千上万个 Token。
    **修改 $Q$ 的成本，远远小于解压所有 $K$ 的成本。**

---

## 4. 总结：代码里的变化

如果你去看 DeepSeek-V3 的伪代码实现，你会发现 Attention 的逻辑发生了本质变化：

- **以前**：拿着 $Q$，去和 Cache 里的 $K$ 做点积。
- **现在**：
  1.  从 Cache 里拿出来的只是极小的 Latent Vector。
  2.  手里拿着的 $Q$，先经过一个特殊的线性变换（把解压矩阵吃进去）。
  3.  用“变形后的 $Q$”直接去和“压缩的 $K$”做点积。

这就是 **“矩阵吸收”** 的精髓：**把存储的压力，转移成了微不足道的计算压力。** 它不是魔法，它是扎实的数学基本功在工程上的极致应用。
